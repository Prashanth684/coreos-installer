#!/bin/bash

set -e

# Kernel networking params to persist
PERSIST_KERNEL_NET_PARAMS=("ipv6.disable" "net.ifnames" "net.naming-scheme")

# Dracut networking params to persist
# Everything other than rd.neednet.
# List from https://www.mankier.com/7/dracut.cmdline#Description-Network
PERSIST_DRACUT_NET_PARAMS=("ip" "ifname" "rd.route" "bootdev" "BOOTIF" "rd.bootif" "nameserver" "rd.peerdns" "biosdevname" "vlan" "bond" "team" "bridge" "rd.net.timeout.carrier" "coreos.no_persist_ip")

PERSIST_DRACUT_ADDITIONAL_PARAMS=("coreos.autologin")

args=("install")

cmdline=( $(</proc/cmdline) )
karg() {
    local name="$1" value="$2"
    for arg in "${cmdline[@]}"; do
        if [[ "${arg%%=*}" == "${name}" ]]; then
            value="${arg#*=}"
        fi
    done
    echo "${value}"
}

karg_bool() {
    local value=$(karg "$@")
    case "$value" in
        ""|0|no|off) return 1;;
        *) return 0;;
    esac
}

copy_arg() {
    local arg="$1"; shift
    local opt="$1"; shift

    local value="$(karg "${arg}")"
    if [ ! -z "${value}" ]; then
        args+=("${opt}" "${value}")
    fi
}

# Get install device
device="$(karg coreos.inst.install_dev)"
if [ -z "${device}" ]; then
    echo "No install device specified."
    exit 1
fi
if [ "${device##*/}" = "${device}" ]; then
    # karg contains no slashes.  Prepend "/dev/" for compatibility.
    device="/dev/${device}"
fi
args+=("${device}")

# Fetch the Ignition URL, if any, and cache it locally.
ignition_url="$(karg coreos.inst.ignition_url)"
# Ignore "skip" for compatibility
if [ -n "${ignition_url}" -a "${ignition_url}" != "skip" ]; then
    ignition_file="$(mktemp -t coreos-installer-XXXXXX)"
    trap "rm -f \"${ignition_file}\"" EXIT
    curl --progress-bar --retry 5 --fail -o "${ignition_file}" "${ignition_url}"
    args+=("--ignition" "${ignition_file}")
fi

# First-boot kernel arguments. Filter out any args that aren't in our
# list of networking arguments to forward and store them in $firstboot_args
firstboot_args=""
for item in "${cmdline[@]}"; do
    for param in "${PERSIST_KERNEL_NET_PARAMS[@]}" "${PERSIST_DRACUT_NET_PARAMS[@]}"; do
        if [[ $item =~ ^$param(=.*)?$ ]]; then
            firstboot_args+="${item} "
        fi
    done
done

additional_args=""
for item in "${cmdline[@]}"; do
    for param in "${PERSIST_DRACUT_ADDITIONAL_PARAMS[@]}"; do
        if [[ $item =~ ^$param(=.*)?$ ]]; then
            additional_args+="${item} "
        fi
    done
done

# Pass firstboot-kargs if:
#    -additional networking options have been specified, since the default
#     in ignition-dracut specifies `rd.neednet=1 ip=dhcp` when no options are persisted
#    -any args are specified in the additional parameters which today is used
#     only for the autologin option
if [ -n "${firstboot_args}" ]; then
    firstboot_args+="${additional_args}"
    args+=("--firstboot-args" "rd.neednet=1 ${firstboot_args}")
else
   if [ -n "${additional_args}" ]; then
       args+=("--firstboot-args" "${additional_args}")
   fi
fi

# Other args that should just be copied over
copy_arg coreos.inst.image_url       --image-url
copy_arg coreos.inst.platform_id     --platform
copy_arg coreos.inst.stream          --stream

# Insecure boolean
if karg_bool coreos.inst.insecure; then
    args+=("--insecure")
fi

# Ensure device nodes have been created
udevadm settle

# Install
echo "coreos-installer ${args[@]}"
coreos-installer "${args[@]}"

